{% extends 'base.html' %}

{% block title %}Dashboard - HisabDe{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f8f9fa;
    }
    
    .dashboard-header {
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1rem 0;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .search-container {
        max-width: 600px;
        margin: 0 auto;
        position: relative;
    }
    
    .search-box {
        border-radius: 25px;
        border: 1px solid #e0e0e0;
        padding: 12px 20px;
        font-size: 16px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .search-box:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 2px 8px rgba(13,110,253,0.2);
    }
    
    .cards-container {
        padding: 2rem 1rem;
        max-width: 1200px;
        margin: 0 auto;
        columns: 1;
        column-gap: 1rem;
    }
    
    .hisab-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        border: 1px solid #e0e0e0;
        break-inside: avoid;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .hisab-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .modal-transaction-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .modal-transaction-row:last-child {
        border-bottom: none;
    }
    
    .transaction-date {
        font-size: 0.8rem;
        color: #999;
        margin-top: 0.25rem;
    }
    
    .modal-total {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #f0f0f0;
        text-align: right;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .updated-text {
        color: #999;
        font-size: 0.8rem;
        margin-bottom: 1rem;
    }
    
    .reminder-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .new-transaction-form {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .person-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
        border-bottom: 2px solid #0d6efd;
        padding-bottom: 0.5rem;
    }
    
    .transaction-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .transaction-row:last-child {
        border-bottom: none;
    }
    
    .transaction-desc {
        color: #333;
        font-size: 0.9rem;
        flex: 1;
    }
    
    .transaction-amount {
        font-weight: 600;
        font-size: 1rem;
        margin-left: 1rem;
    }
    
    .amount-positive {
        color: #198754;
    }
    
    .amount-negative {
        color: #dc3545;
    }
    
    .total-amount {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #f0f0f0;
        text-align: right;
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .fab-add {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #0d6efd;
        color: white;
        border: none;
        font-size: 1.5rem;
        box-shadow: 0 4px 12px rgba(13,110,253,0.4);
        transition: all 0.3s ease;
        z-index: 1000;
    }
    
    .fab-add:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(13,110,253,0.5);
    }
    
    .nav-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 1rem;
    }
    
    .user-menu {
        position: relative;
    }
    
    .user-avatar {
        background: #0d6efd;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        cursor: pointer;
        border: none;
    }
    
    @media (min-width: 768px) {
        .cards-container {
            columns: 2;
        }
    }
    
    @media (min-width: 1024px) {
        .cards-container {
            columns: 3;
        }
    }
    
    @media (min-width: 1200px) {
        .cards-container {
            columns: 4;
        }
    }
    
    /* Modal Styles */
    .modal-bottom {
        padding-top: 1rem;
        border-top: 1px solid #f0f0f0;
        margin-top: 1rem;
    }
    
    .add-transaction-section .dropdown-menu {
        border: 1px solid #dee2e6;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    /* Mobile responsive for modal buttons */
    @media (max-width: 576px) {
        .modal-bottom {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .action-buttons {
            width: 100%;
            justify-content: space-between;
        }
        
        .action-buttons .btn {
            flex: 1;
        }
        
        .add-transaction-section .dropdown-menu {
            min-width: 280px !important;
        }
    }
    
    /* Focus styles for transaction descriptions */
    .modal-transaction-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .modal-transaction-row:last-child {
        border-bottom: none;
    }
    
    .modal-transaction-row .transaction-desc {
        color: #333;
        font-weight: 500;
        font-size: 0.95rem;
    }
    
    .modal-transaction-row .transaction-date {
        color: #666;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
    
    .modal-transaction-row .transaction-amount {
        font-weight: 600;
        font-size: 1rem;
    }
    
    /* New Modal Styles */
    .person-info-section {
        background: #f8f9fa;
    }
    
    .transaction-list-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .transaction-item:last-child {
        border-bottom: none;
    }
    
    .transaction-content {
        flex: 1;
    }
    
    .transaction-desc-modal {
        font-size: 0.95rem;
        color: #333;
        margin-bottom: 2px;
    }
    
    .transaction-date-modal {
        font-size: 0.8rem;
        color: #666;
    }
    
    .transaction-amount-modal {
        font-weight: 600;
        font-size: 1rem;
    }
    
    .transaction-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .transaction-item:last-child {
        border-bottom: none;
    }
    
    .transaction-item .btn {
        border: 1px solid #dee2e6;
    }
    
    .transaction-buttons {
        flex-wrap: nowrap;
    }
    
    .transaction-amount-section {
        min-width: fit-content;
    }
    
    @media (max-width: 576px) {
        .transaction-item {
            padding: 0.5rem 0;
        }
        
        .transaction-buttons {
            flex-direction: column;
            gap: 0.25rem !important;
        }
        

        
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .add-transaction-section .row {
            margin-bottom: 0.5rem;
        }
    }
    
    /* Use Bootstrap's default button styles */
    
    /* Card header with 3-dot menu */
    .card-header {
        margin-bottom: 12px;
    }
    
    .dropdown-toggle::after {
        display: none;
    }
    
    /* Mobile responsive */
    @media (max-width: 576px) {
        .modal-dialog {
            margin: 10px;
        }
        
        .add-transaction-section .row {
            --bs-gutter-x: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header with Search -->
<div class="dashboard-header">
    <div class="container-fluid">
        <div class="nav-bar">
            <h4 class="mb-0 text-primary fw-bold">HisabDe</h4>
            <div class="user-menu">
                <div class="dropdown">
                    <button class="user-avatar dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        {{ user.get_short_name|first|upper }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'profile' %}">üë§ Profile</a></li>
                        <li><a class="dropdown-item" href="{% url 'password_change' %}">üîí Change Password</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form method="post" action="{% url 'logout' %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item">üö™ Logout</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="search-container mt-3">
            <input type="text" class="form-control search-box" placeholder="Search transactions, people, or amounts..." id="searchInput">
        </div>
    </div>
</div>

<!-- Cards Container -->
<div class="cards-container">
    <!-- Card 1: Ahmed Ali -->
    <div class="hisab-card" data-bs-toggle="modal" data-bs-target="#detailModal" 
         data-person="Ahmed Ali" data-total="-450" data-updated="2025-10-12">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="person-name">Ahmed Ali</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Lunch at restaurant</div>
            <div class="transaction-amount amount-negative">-‚Çπ250</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Movie tickets</div>
            <div class="transaction-amount amount-negative">-‚Çπ400</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Petrol money</div>
            <div class="transaction-amount amount-positive">+‚Çπ200</div>
        </div>
        <div class="total-amount amount-negative">Total: -‚Çπ450</div>
    </div>
    
    <!-- Card 2: Sarah Khan -->
    <div class="hisab-card" data-bs-toggle="modal" data-bs-target="#detailModal" 
         data-person="Sarah Khan" data-total="-2000" data-updated="2025-10-10">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="person-name">Sarah Khan</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Grocery shopping</div>
            <div class="transaction-amount amount-negative">-‚Çπ1200</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Electricity bill</div>
            <div class="transaction-amount amount-negative">-‚Çπ800</div>
        </div>
        <div class="total-amount amount-negative">Total: -‚Çπ2000</div>
    </div>
    
    <!-- Card 3: Rahul Sharma -->
    <div class="hisab-card" data-bs-toggle="modal" data-bs-target="#detailModal" 
         data-person="Rahul Sharma" data-total="50" data-updated="2025-10-11">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="person-name">Rahul Sharma</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Birthday party contribution</div>
            <div class="transaction-amount amount-positive">+‚Çπ500</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Pizza order</div>
            <div class="transaction-amount amount-negative">-‚Çπ300</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Cab fare</div>
            <div class="transaction-amount amount-negative">-‚Çπ150</div>
        </div>
        <div class="total-amount amount-positive">Total: +‚Çπ50</div>
    </div>
    
    <!-- Card 4: Priya Patel -->
    <div class="hisab-card" data-bs-toggle="modal" data-bs-target="#detailModal" 
         data-person="Priya Patel" data-total="330" data-updated="2025-10-09">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="person-name">Priya Patel</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Coffee meetup</div>
            <div class="transaction-amount amount-negative">-‚Çπ120</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Book borrowed money</div>
            <div class="transaction-amount amount-positive">+‚Çπ450</div>
        </div>
        <div class="total-amount amount-positive">Total: +‚Çπ330</div>
    </div>
    
    <!-- Card 5: Vikram Singh -->
    <div class="hisab-card" data-bs-toggle="modal" data-bs-target="#detailModal" 
         data-person="Vikram Singh" data-total="-1300" data-updated="2025-10-08">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="person-name">Vikram Singh</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Gym membership</div>
            <div class="transaction-amount amount-negative">-‚Çπ2000</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Protein supplement</div>
            <div class="transaction-amount amount-negative">-‚Çπ800</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Tournament prize money</div>
            <div class="transaction-amount amount-positive">+‚Çπ1500</div>
        </div>
        <div class="total-amount amount-negative">Total: -‚Çπ1300</div>
    </div>
    
    <!-- Card 6: Anjali Gupta -->
    <div class="hisab-card" data-bs-toggle="modal" data-bs-target="#detailModal" 
         data-person="Anjali Gupta" data-total="-1700" data-updated="2025-10-07">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="person-name">Anjali Gupta</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Wedding gift</div>
            <div class="transaction-amount amount-negative">-‚Çπ2500</div>
        </div>
        <div class="transaction-row">
            <div class="transaction-desc">Travel reimbursement</div>
            <div class="transaction-amount amount-positive">+‚Çπ800</div>
        </div>
        <div class="total-amount amount-negative">Total: -‚Çπ1700</div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="fab-add" title="Add New Transaction">
    +
</button>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 d-flex justify-content-between align-items-center">
                <h5 class="modal-title" id="detailModalLabel">Account Details</h5>
                <div class="dropdown">
                    <button class="btn btn-outline-primary btn-sm dropdown-toggle rounded-pill" type="button" id="reminderDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="reminderText">Remind: None</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="setReminder('daily')">Daily</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setReminder('weekly')">Weekly</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setReminder('monthly')">Monthly</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setReminder('yearly')">Yearly</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-muted" href="#" onclick="clearReminder()">Clear Reminder</a></li>
                    </ul>
                </div>
            </div>
            <div class="modal-body p-0">
                <!-- Person Info Section -->
                <div class="person-info-section p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1" id="modalPersonName">Person Name</h6>
                            <small class="text-muted">Total Amount</small>
                        </div>
                        <div class="text-end">
                            <div id="modalTotalAmount" class="fs-5 fw-bold">‚Çπ0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Transaction List -->
                <div class="transaction-list-container">
                    <div id="modalTransactionList" class="transaction-list p-3">
                        <!-- Transactions will be populated here by JavaScript -->
                    </div>
                </div>
                
                <!-- Add Transaction Section -->
                <div class="add-transaction-section p-2 border-top bg-light">
                    <div class="row g-1 mb-2">
                        <div class="col-12 col-md-6">
                            <input type="text" class="form-control form-control-sm" placeholder="Description" id="newDescription">
                        </div>
                        <div class="col-6 col-md-3">
                            <input type="number" class="form-control form-control-sm" placeholder="Amount" id="newAmount">
                        </div>
                        <div class="col-6 col-md-3">
                            <input type="date" class="form-control form-control-sm" id="newDate">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary btn-sm w-100" onclick="addNewTransaction()">
                                Add Transaction
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Footer with Update and Bill Status -->
                <div class="modal-footer border-0 bg-light pt-2">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <small class="text-muted">Updated: <span id="modalUpdatedAt"></span></small>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteCard()">
                                Delete
                            </button>
                            <button type="button" class="btn btn-secondary text-white btn-sm" onclick="remindNow()">
                                Remind
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" onclick="updateTransactions()">
                                Update
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
// Sample transaction data for each person
const transactionData = {
    'Ahmed Ali': [
        { desc: 'Lunch at restaurant', amount: -250, date: '2025-10-12' },
        { desc: 'Movie tickets', amount: -400, date: '2025-10-11' },
        { desc: 'Petrol money', amount: 200, date: '2025-10-10' }
    ],
    'Sarah Khan': [
        { desc: 'Grocery shopping', amount: -1200, date: '2025-10-10' },
        { desc: 'Electricity bill', amount: -800, date: '2025-10-09' }
    ],
    'Rahul Sharma': [
        { desc: 'Birthday party contribution', amount: 500, date: '2025-10-11' },
        { desc: 'Pizza order', amount: -300, date: '2025-10-10' },
        { desc: 'Cab fare', amount: -150, date: '2025-10-09' }
    ],
    'Priya Patel': [
        { desc: 'Coffee meetup', amount: -120, date: '2025-10-09' },
        { desc: 'Book borrowed money', amount: 450, date: '2025-10-08' }
    ],
    'Vikram Singh': [
        { desc: 'Gym membership', amount: -2000, date: '2025-10-08' },
        { desc: 'Protein supplement', amount: -800, date: '2025-10-07' },
        { desc: 'Tournament prize money', amount: 1500, date: '2025-10-06' }
    ],
    'Anjali Gupta': [
        { desc: 'Wedding gift', amount: -2500, date: '2025-10-07' },
        { desc: 'Travel reimbursement', amount: 800, date: '2025-10-06' }
    ]
};

let currentPerson = '';

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const cards = document.querySelectorAll('.hisab-card');
    
    cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
});

// Modal event listener
document.getElementById('detailModal').addEventListener('show.bs.modal', function(event) {
    const card = event.relatedTarget;
    currentPerson = card.getAttribute('data-person');
    const total = card.getAttribute('data-total');
    const updated = card.getAttribute('data-updated');
    
    // Set modal person name and updated date
    document.getElementById('modalPersonName').textContent = currentPerson;
    document.getElementById('modalUpdatedAt').textContent = new Date(updated).toLocaleDateString();
    
    // Set current reminder state
    const currentReminder = reminderStates[currentPerson];
    if (currentReminder) {
        document.getElementById('reminderText').textContent = `Remind: ${currentReminder}`;
    } else {
        document.getElementById('reminderText').textContent = 'Remind: None';
    }
    
    // Populate transactions
    const transactionList = document.getElementById('modalTransactionList');
    transactionList.innerHTML = '';
    
    const transactions = transactionData[currentPerson] || [];
    transactions.forEach((transaction, index) => {
        const row = document.createElement('div');
        row.className = 'transaction-item d-flex justify-content-between align-items-start';
        row.innerHTML = `
            <div class="transaction-content flex-grow-1">
                <div class="transaction-desc-modal" id="desc-${index}">${transaction.desc}</div>
                <div class="transaction-date-modal text-muted small" id="date-${index}">${new Date(transaction.date).toLocaleDateString()}</div>
            </div>
            <div class="transaction-amount-section text-end">
                <div class="transaction-amount-modal ${transaction.amount >= 0 ? 'amount-positive' : 'amount-negative'} mb-1" id="amount-${index}">
                    ${transaction.amount >= 0 ? '+' : ''}‚Çπ${Math.abs(transaction.amount)}
                </div>
                <div class="transaction-buttons d-flex gap-1">
                    <button class="btn btn-sm btn-outline-primary" onclick="editTransaction(${index})" id="edit-btn-${index}" title="Edit">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn btn-sm btn-outline-success d-none" onclick="saveTransaction(${index})" id="save-btn-${index}" title="Save">
                        ‚úì
                    </button>
                    <button class="btn btn-sm btn-outline-secondary d-none" onclick="cancelEdit(${index})" id="cancel-btn-${index}" title="Cancel">
                        ‚úï
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${index})" id="delete-btn-${index}" title="Delete">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `;
        transactionList.appendChild(row);
    });
    
    // Set total amount
    const totalAmount = document.getElementById('modalTotalAmount');
    const totalValue = parseInt(total);
    totalAmount.className = `fs-5 fw-bold ${totalValue >= 0 ? 'amount-positive' : 'amount-negative'}`;
    totalAmount.textContent = `${totalValue >= 0 ? '+' : ''}‚Çπ${Math.abs(totalValue)}`;
});

// Add new transaction
function addNewTransaction() {
    const description = document.getElementById('newDescription').value;
    const amount = document.getElementById('newAmount').value;
    const date = document.getElementById('newDate').value || new Date().toISOString().split('T')[0];
    
    if (!description || !amount) {
        alert('Please enter both description and amount');
        return;
    }
    
    if (!transactionData[currentPerson]) {
        transactionData[currentPerson] = [];
    }
    
    transactionData[currentPerson].push({
        desc: description,
        amount: parseFloat(amount),
        date: date
    });
    
    // Clear form
    document.getElementById('newDescription').value = '';
    document.getElementById('newAmount').value = '';
    document.getElementById('newDate').value = '';
    
    // Recalculate total
    const newTotal = transactionData[currentPerson].reduce((sum, t) => sum + t.amount, 0);
    
    // Update card total
    const card = document.querySelector(`[data-person="${currentPerson}"]`);
    card.setAttribute('data-total', newTotal);
    
    // Update card display
    const totalElement = card.querySelector('.total-amount');
    if (totalElement) {
        totalElement.className = `total-amount ${newTotal >= 0 ? 'amount-positive' : 'amount-negative'}`;
        totalElement.textContent = `Total: ${newTotal >= 0 ? '+' : ''}‚Çπ${Math.abs(newTotal)}`;
    }
    
    // Refresh modal
    populateTransactionList();
    updateModalTotal(newTotal);
    
    alert('Transaction added successfully!');
}

// Store reminder states for each person
let reminderStates = {};

// Set reminder
function setReminder(frequency) {
    if (frequency) {
        reminderStates[currentPerson] = frequency;
        document.getElementById('reminderText').textContent = `Remind: ${frequency}`;
        alert(`${frequency.charAt(0).toUpperCase() + frequency.slice(1)} reminder set for ${currentPerson}!`);
    }
}

// Clear reminder
function clearReminder() {
    reminderStates[currentPerson] = null;
    document.getElementById('reminderText').textContent = 'Remind: None';
    alert(`Reminder cleared for ${currentPerson}!`);
}

// Remind now function
function remindNow() {
    alert(`Reminder sent to ${currentPerson} immediately!`);
}

// Update transactions
function updateTransactions() {
    alert('Bill status updated successfully!');
}

// Delete transaction function
function deleteTransaction(index) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        if (transactionData[currentPerson]) {
            transactionData[currentPerson].splice(index, 1);
        }
        
        // Refresh the modal
        const modal = document.getElementById('detailModal');
        const card = document.querySelector(`[data-person="${currentPerson}"]`);
        
        // Recalculate total
        let newTotal = 0;
        if (transactionData[currentPerson]) {
            newTotal = transactionData[currentPerson].reduce((sum, t) => sum + t.amount, 0);
        }
        
        // Update card total
        card.setAttribute('data-total', newTotal);
        
        // Update card display
        const totalElement = card.querySelector('.total-amount');
        if (totalElement) {
            totalElement.className = `total-amount ${newTotal >= 0 ? 'amount-positive' : 'amount-negative'}`;
            totalElement.textContent = `Total: ${newTotal >= 0 ? '+' : ''}‚Çπ${Math.abs(newTotal)}`;
        }
        
        // Refresh transaction list in modal
        populateTransactionList();
        updateModalTotal(newTotal);
    }
}

// Delete card function
function deleteCard() {
    if (confirm(`Are you sure you want to delete ${currentPerson}'s account?`)) {
        // Remove from data
        delete transactionData[currentPerson];
        
        // Remove card from DOM
        const card = document.querySelector(`[data-person="${currentPerson}"]`);
        if (card) {
            card.remove();
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('detailModal'));
        modal.hide();
        
        alert(`${currentPerson}'s account deleted successfully!`);
    }
}

// Helper function to populate transaction list
function populateTransactionList() {
    const transactionList = document.getElementById('modalTransactionList');
    transactionList.innerHTML = '';
    
    const transactions = transactionData[currentPerson] || [];
    transactions.forEach((transaction, index) => {
        const row = document.createElement('div');
        row.className = 'transaction-item d-flex justify-content-between align-items-start';
        row.innerHTML = `
            <div class="transaction-content flex-grow-1">
                <div class="transaction-desc-modal" id="desc-${index}">${transaction.desc}</div>
                <div class="transaction-date-modal text-muted small" id="date-${index}">${new Date(transaction.date).toLocaleDateString()}</div>
            </div>
            <div class="transaction-amount-section text-end">
                <div class="transaction-amount-modal ${transaction.amount >= 0 ? 'amount-positive' : 'amount-negative'} mb-1" id="amount-${index}">
                    ${transaction.amount >= 0 ? '+' : ''}‚Çπ${Math.abs(transaction.amount)}
                </div>
                <div class="transaction-buttons d-flex gap-1">
                    <button class="btn btn-sm btn-outline-primary" onclick="editTransaction(${index})" id="edit-btn-${index}" title="Edit">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn btn-sm btn-outline-success d-none" onclick="saveTransaction(${index})" id="save-btn-${index}" title="Save">
                        ‚úì
                    </button>
                    <button class="btn btn-sm btn-outline-secondary d-none" onclick="cancelEdit(${index})" id="cancel-btn-${index}" title="Cancel">
                        ‚úï
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${index})" id="delete-btn-${index}" title="Delete">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `;
        transactionList.appendChild(row);
    });
}

// Helper function to update modal total
function updateModalTotal(total) {
    const totalAmount = document.getElementById('modalTotalAmount');
    totalAmount.className = `fs-5 fw-bold ${total >= 0 ? 'amount-positive' : 'amount-negative'}`;
    totalAmount.textContent = `${total >= 0 ? '+' : ''}‚Çπ${Math.abs(total)}`;
}

// Edit transaction function
function editTransaction(index) {
    const descElement = document.getElementById(`desc-${index}`);
    const dateElement = document.getElementById(`date-${index}`);
    const amountElement = document.getElementById(`amount-${index}`);
    const editBtn = document.getElementById(`edit-btn-${index}`);
    const saveBtn = document.getElementById(`save-btn-${index}`);
    const cancelBtn = document.getElementById(`cancel-btn-${index}`);
    const deleteBtn = document.getElementById(`delete-btn-${index}`);
    
    // Store original values
    const originalDesc = descElement.textContent;
    const originalAmount = transactionData[currentPerson][index].amount;
    const originalDate = transactionData[currentPerson][index].date;
    
    // Convert to input fields - mobile responsive
    const row = descElement.closest('.transaction-item');
    row.innerHTML = `
        <div class="w-100">
            <div class="row g-1 mb-2">
                <div class="col-12">
                    <input type="text" class="form-control form-control-sm" value="${originalDesc}" id="edit-desc-${index}" placeholder="Description">
                </div>
            </div>
            <div class="row g-1 mb-2">
                <div class="col-6">
                    <input type="number" class="form-control form-control-sm" value="${originalAmount}" id="edit-amount-${index}" placeholder="Amount">
                </div>
                <div class="col-6">
                    <input type="date" class="form-control form-control-sm" value="${originalDate}" id="edit-date-${index}">
                </div>
            </div>
            <div class="d-flex gap-1 justify-content-end">
                <button class="btn btn-sm btn-outline-success" onclick="saveTransaction(${index})" id="save-btn-${index}" title="Save">
                    ‚úÖ
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="cancelEdit(${index})" id="cancel-btn-${index}" title="Cancel">
                    ‚ùå
                </button>
            </div>
        </div>
    `;
}

// Save transaction function
function saveTransaction(index) {
    const newDesc = document.getElementById(`edit-desc-${index}`).value;
    const newAmount = parseFloat(document.getElementById(`edit-amount-${index}`).value);
    const newDate = document.getElementById(`edit-date-${index}`).value;
    
    if (!newDesc.trim() || isNaN(newAmount) || !newDate) {
        alert('Please enter valid description, amount and date');
        return;
    }
    
    // Update data
    transactionData[currentPerson][index].desc = newDesc;
    transactionData[currentPerson][index].amount = newAmount;
    transactionData[currentPerson][index].date = newDate;
    
    // Recalculate and update total
    const newTotal = transactionData[currentPerson].reduce((sum, t) => sum + t.amount, 0);
    
    // Update card total
    const card = document.querySelector(`[data-person="${currentPerson}"]`);
    card.setAttribute('data-total', newTotal);
    
    // Update card display
    const totalElement = card.querySelector('.total-amount');
    if (totalElement) {
        totalElement.className = `total-amount ${newTotal >= 0 ? 'amount-positive' : 'amount-negative'}`;
        totalElement.textContent = `Total: ${newTotal >= 0 ? '+' : ''}‚Çπ${Math.abs(newTotal)}`;
    }
    
    // Refresh modal
    populateTransactionList();
    updateModalTotal(newTotal);
    
    alert('Transaction updated successfully!');
}

// Cancel edit function
function cancelEdit(index) {
    // Simply refresh the transaction list to revert changes
    populateTransactionList();
}

// FAB click handler
document.querySelector('.fab-add').addEventListener('click', function() {
    alert('Add new person/account feature coming soon!');
});
</script>
{% endblock %}